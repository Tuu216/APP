import requests
from config import TOGETHER_API_KEY, TOGETHER_API_URL
from together import Together
from LLM_roel import system
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import os
import json
import logging

# è¨­å®šæ—¥èªŒ
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

class TravelChatbot:
    def __init__(self, model="meta-llama/Llama-4-Scout-17B-16E-Instruct", max_history=10):
        self.client = Together(api_key=TOGETHER_API_KEY)
        self.model = model
        self.max_history = max_history
        self.messages = [{"role": "system", "content": system}]

    def chat(self, user_query):
        try:
            cached_response = self.get_cached_response(user_query)
            if cached_response:
                return cached_response
            self.messages.append({"role": "user", "content": user_query})
            chat_completion = self.client.chat.completions.create(
                messages=self.messages,
                model=self.model,
            )
            reply = chat_completion.choices[0].message.content
            self.messages.append({"role": "assistant", "content": reply})
            if len(self.messages) > self.max_history:
                self.messages = [self.messages[0]] + self.messages[-(self.max_history-1):]
            self.cache_response(user_query, reply)
            self.set_current_itinerary(user_query, reply)
            df = self.parse_response_to_df(reply)
            print("\n### çµæ§‹åŒ–æ¨è–¦ ###")
            print(df)
            return reply
        except requests.exceptions.RequestException as e:
            logger.error(f"ç¶²è·¯éŒ¯èª¤: {str(e)}")
            return "ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦ã€‚"
        except Exception as e:
            if "429" in str(e):
                logger.error("API é…é¡è¶…é™")
                return "API è«‹æ±‚éå¤šï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥ Together AI é…é¡ã€‚"
            logger.error(f"API å‘¼å«å¤±æ•—: {str(e)}")
            return "æŠ±æ­‰ï¼Œç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"

    def parse_response_to_df(self, response):
        lines = response.split('\n')
        data = []
        current_place = {}
        for line in lines:
            line = line.strip()
            if line.startswith('- åç¨±:'):
                if current_place:
                    data.append(current_place)
                current_place = {'åç¨±': line.replace('- åç¨±:', '').strip()}
            elif line.startswith('- æè¿°:'):
                current_place['æè¿°'] = line.replace('- æè¿°:', '').strip()
            elif line.startswith('- é©åˆè¦ªå­çš„åŸå› :'):
                current_place['é©åˆè¦ªå­çš„åŸå› '] = line.replace('- é©åˆè¦ªå­çš„åŸå› :', '').strip()
            elif line.startswith('- äº¤é€šæ–¹å¼:'):
                current_place['äº¤é€šæ–¹å¼'] = line.replace('- äº¤é€šæ–¹å¼:', '').strip()
        if current_place:
            data.append(current_place)
        df = pd.DataFrame(data)
        df.to_csv('taichung_attractions.csv', index=False, encoding='utf-8')
        return df

    def get_cached_response(self, user_query):
        cache_file = "response_cache.json"
        if os.path.exists(cache_file):
            with open(cache_file, 'r', encoding='utf-8') as f:
                cache = json.load(f)
            for entry in cache:
                if entry["query"] == user_query:
                    logger.info("å¾å¿«å–ä¸­å–å¾—å›æ‡‰")
                    return entry["response"]
        return None

    def cache_response(self, user_query, response):
        cache_file = "response_cache.json"
        cache = []
        if os.path.exists(cache_file):
            with open(cache_file, 'r', encoding='utf-8') as f:
                cache = json.load(f)
        cache.append({"query": user_query, "response": response})
        with open(cache_file, 'w', encoding='utf-8') as f:
            json.dump(cache, f, ensure_ascii=False, indent=2)

    def save_conversation(self, filename="conversation.json"):
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(self.messages, f, ensure_ascii=False, indent=2)

    def load_conversation(self, filename="conversation.json"):
        if os.path.exists(filename):
            with open(filename, 'r', encoding='utf-8') as f:
                self.messages = json.load(f)
            logger.info("å°è©±æ­·å²å·²è¼‰å…¥")
        else:
            logger.warning("æ‰¾ä¸åˆ°å°è©±æ­·å²æª”æ¡ˆï¼Œä½¿ç”¨é è¨­ç³»çµ±è¨Šæ¯")

    def set_current_itinerary(self, query, response):
        with open("current_itinerary.json", 'w', encoding='utf-8') as f:
            json.dump({"query": query, "response": response}, f, ensure_ascii=False, indent=2)

    def get_current_itinerary(self):
        if os.path.exists("current_itinerary.json"):
            with open("current_itinerary.json", 'r', encoding='utf-8') as f:
                return json.load(f)
        return None

    def reset_conversation(self):
        self.messages = [{"role": "system", "content": system}]
        logger.info("å°è©±æ­·å²å·²é‡ç½®")

def main():
    print("ğŸš€ è¦ªå­æ—…éŠæ¨è–¦ç³»çµ±å•Ÿå‹•ï¼è¼¸å…¥ 'é€€å‡º' ä»¥çµæŸã€‚")
    chatbot = TravelChatbot()
    while True:
        user_query = input("è«‹è¼¸å…¥æ‚¨çš„æ—…éŠæŸ¥è©¢ï¼ˆä¾‹å¦‚ï¼šå°ä¸­è¦ªå­æ™¯é»ï¼‰ï¼š").strip()
        if user_query.lower() in ['é€€å‡º', 'exit', 'quit']:
            print("æ„Ÿè¬ä½¿ç”¨æ—…éŠæ¨è–¦ç³»çµ±ï¼")
            break
        if not user_query:
            print("è¼¸å…¥ä¸èƒ½ä¸ºç©ºï¼Œè«‹é‡æ–°è¼¸å…¥ï¼")
            continue
        response = chatbot.chat(user_query)
        print("\n### æ¨è–¦çµæœ ###")
        print(response)
        print("\n")
        chatbot.save_conversation()

if __name__ == "__main__":
    main()